<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lua引擎 | 记录游戏逆向学习</title>
    <meta name="generator" content="VuePress 1.9.5">
    
    <meta name="description" content="记录游戏逆向学习">
    
    <link rel="preload" href="/game-reversed-study/assets/css/0.styles.04c94cd1.css" as="style"><link rel="preload" href="/game-reversed-study/assets/js/app.ed2c23ab.js" as="script"><link rel="preload" href="/game-reversed-study/assets/js/2.2445e019.js" as="script"><link rel="preload" href="/game-reversed-study/assets/js/13.86901e94.js" as="script"><link rel="prefetch" href="/game-reversed-study/assets/js/10.fe27465a.js"><link rel="prefetch" href="/game-reversed-study/assets/js/11.587e87fc.js"><link rel="prefetch" href="/game-reversed-study/assets/js/12.0b10392e.js"><link rel="prefetch" href="/game-reversed-study/assets/js/14.a5dd21dd.js"><link rel="prefetch" href="/game-reversed-study/assets/js/15.fb4e33b8.js"><link rel="prefetch" href="/game-reversed-study/assets/js/16.2ee78634.js"><link rel="prefetch" href="/game-reversed-study/assets/js/17.eb72810d.js"><link rel="prefetch" href="/game-reversed-study/assets/js/18.44318a7e.js"><link rel="prefetch" href="/game-reversed-study/assets/js/19.508a22cc.js"><link rel="prefetch" href="/game-reversed-study/assets/js/20.3052c91a.js"><link rel="prefetch" href="/game-reversed-study/assets/js/21.112a624d.js"><link rel="prefetch" href="/game-reversed-study/assets/js/22.05698a69.js"><link rel="prefetch" href="/game-reversed-study/assets/js/23.2dbf451a.js"><link rel="prefetch" href="/game-reversed-study/assets/js/24.7b20b918.js"><link rel="prefetch" href="/game-reversed-study/assets/js/25.dad8bfea.js"><link rel="prefetch" href="/game-reversed-study/assets/js/26.304392f2.js"><link rel="prefetch" href="/game-reversed-study/assets/js/27.c8611ac2.js"><link rel="prefetch" href="/game-reversed-study/assets/js/28.590999c2.js"><link rel="prefetch" href="/game-reversed-study/assets/js/29.a4e199d3.js"><link rel="prefetch" href="/game-reversed-study/assets/js/3.d2aad6e2.js"><link rel="prefetch" href="/game-reversed-study/assets/js/30.c0a95e10.js"><link rel="prefetch" href="/game-reversed-study/assets/js/31.9e8d74cf.js"><link rel="prefetch" href="/game-reversed-study/assets/js/32.50963194.js"><link rel="prefetch" href="/game-reversed-study/assets/js/33.d52fcd99.js"><link rel="prefetch" href="/game-reversed-study/assets/js/34.661eeb19.js"><link rel="prefetch" href="/game-reversed-study/assets/js/4.de5fb282.js"><link rel="prefetch" href="/game-reversed-study/assets/js/5.0f63ad75.js"><link rel="prefetch" href="/game-reversed-study/assets/js/6.e8d89293.js"><link rel="prefetch" href="/game-reversed-study/assets/js/7.2c26eb0f.js"><link rel="prefetch" href="/game-reversed-study/assets/js/8.d897f318.js"><link rel="prefetch" href="/game-reversed-study/assets/js/9.e2e72d4c.js">
    <link rel="stylesheet" href="/game-reversed-study/assets/css/0.styles.04c94cd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/game-reversed-study/" class="home-link router-link-active"><!----> <span class="site-name">记录游戏逆向学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/januwA/game-reversed-study" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/januwA/game-reversed-study" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>/</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AAScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Ghidra</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>LUA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/game-reversed-study/LUA/ce-form.html" class="sidebar-link">ce-form</a></li><li><a href="/game-reversed-study/LUA/lua-plugin.html" class="sidebar-link">lua-plugin</a></li><li><a href="/game-reversed-study/LUA/lua.html" aria-current="page" class="active sidebar-link">lua</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#lua引擎" class="sidebar-link">Lua引擎</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#添加断点" class="sidebar-link">添加断点</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#读写指针" class="sidebar-link">读写指针</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#将aa脚本转化为lua" class="sidebar-link">将AA脚本转化为Lua</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#使用settimeout和setinterval更简单的计时器" class="sidebar-link">使用setTimeout和setInterval更简单的计时器</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#自动附加到进程" class="sidebar-link">自动附加到进程</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#使用ini配置" class="sidebar-link">使用ini配置</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#导入lua文件" class="sidebar-link">导入lua文件</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#转换工具函数" class="sidebar-link">转换工具函数</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#在远程进程中执行messageboxa-x64" class="sidebar-link">在远程进程中执行MessageBoxA x64</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#设置游戏速度" class="sidebar-link">设置游戏速度</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#aobscan-找到过于复杂的字节集" class="sidebar-link">AOBScan 找到过于复杂的字节集</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#重写多个相同的字节集" class="sidebar-link">重写多个相同的字节集</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#获取当前脚本memoryrecord上下文" class="sidebar-link">获取当前脚本MemoryRecord上下文</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#aa脚本调用lua函数" class="sidebar-link">AA脚本调用LUA函数</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#xbox-按键" class="sidebar-link">XBOX 按键</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#获取打开的进程id" class="sidebar-link">获取打开的进程ID</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#获取目标进程的窗口句柄" class="sidebar-link">获取目标进程的窗口句柄</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#获取窗口的rect" class="sidebar-link">获取窗口的RECT</a></li><li class="sidebar-sub-header"><a href="/game-reversed-study/LUA/lua.html#在lua中调用win32-api" class="sidebar-link">在LUA中调用win32 API</a></li></ul></li><li><a href="/game-reversed-study/LUA/使用计时器.html" class="sidebar-link">使用计时器</a></li><li><a href="/game-reversed-study/LUA/鼠标自动点击.html" class="sidebar-link">鼠标自动点击</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ReClass</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>cpp-hack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>dnspy</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="lua引擎"><a href="#lua引擎" class="header-anchor">#</a> Lua引擎</h2> <p><a href="https://www.youtube.com/watch?v=hnZyZio5FBQ&amp;list=PLNffuWEygffbbT9Vz-Y1NXQxv2m6mrmHr&amp;index=69" target="_blank" rel="noopener noreferrer">视频教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://wiki.cheatengine.org/index.php?title=Lua" target="_blank" rel="noopener noreferrer">ce lua api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>通用修改器，文件-&gt;从表单中生成通用修改器，会打开一个ui编辑器，可也打包为exe可执行文件，和运行lua脚本</p> <p>内存浏览器 -&gt; 工具-&gt; Lua引擎, 快捷键 ctrl+l 可以打开一个lua的调试器</p> <p>这里使用了<code>xxx</code>符号，所以脚本需要打开，不然会失败：
<img src="/game-reversed-study/assets/img/2020-06-02-16-55-07.0e357f82.png" alt=""></p> <h2 id="添加断点"><a href="#添加断点" class="header-anchor">#</a> 添加断点</h2> <div class="language- extra-class"><pre class="language-text"><code>debugProcess()

myaddress = getAddress(&quot;game.exe+4BA45&quot;)
debug_setBreakpoint(myaddress);
</code></pre></div><p>在断下后，可以获取数据:</p> <div class="language- extra-class"><pre class="language-text"><code>debugProcess()
myaddress = getAddress(&quot;PlantsVsZombies.exe+4BA45&quot;)

myvar=EAX
print(myvar)
print(EAX)
print(EDI)
debug_removeBreakpoint(myaddress);
</code></pre></div><h2 id="读写指针"><a href="#读写指针" class="header-anchor">#</a> 读写指针</h2> <p><img src="/game-reversed-study/assets/img/2020-06-03-08-25-46.794d8d56.png" alt=""></p> <div class="language- extra-class"><pre class="language-text"><code>print(readInteger('[[&quot;PlantsVsZombies.exe&quot;+0x379618]+0x868]+0x5578'))
writeInteger('[[&quot;PlantsVsZombies.exe&quot;+0x379618]+0x868]+0x5578', 200)
</code></pre></div><h2 id="将aa脚本转化为lua"><a href="#将aa脚本转化为lua" class="header-anchor">#</a> <a href="https://www.youtube.com/watch?v=eEg3q2qocwQ&amp;list=PLNffuWEygffbbT9Vz-Y1NXQxv2m6mrmHr&amp;index=71" target="_blank" rel="noopener noreferrer">将AA脚本转化为Lua<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>AA脚本:</p> <div class="language- extra-class"><pre class="language-text"><code>define(address,&quot;PlantsVsZombies.exe&quot;+B2FF0)
define(bytes,3B 47 28 7E 12)

[ENABLE]
Assert(address,bytes)
Alloc(newmem,$1000)

label(return)

newmem:
  cmp eax,[edi+28]
  nop
  nop
  jmp return

address:
  jmp newmem
return:

[DISABLE]
address:
  db bytes

deAlloc(newmem)
</code></pre></div><p>Lua AA Script:</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}

[ENABLE]
bytes = {0x3B , 0x47 , 0x28 , 0x7E , 0x12}

-- 要创建符号autoAssemble里面才能访问
address = '&quot;PlantsVsZombies.exe&quot;+B2FF0'
registerSymbol(&quot;address&quot;, address)

mem = allocateMemory(0x1000)
registerSymbol(&quot;newmem&quot;, mem)

autoAssemble([[
  label(return)

  newmem:
    cmp eax,[edi+28]
    nop
    nop
    jmp return

  address:
    jmp newmem
  return:
]])

[DISABLE]
writeBytes(address, bytes)

unregisterSymbol(&quot;newmem&quot;)
unregisterSymbol(&quot;address&quot;)
deAlloc(mem, 0x1000)

address = nil
mem = nil
bytes = nil
</code></pre></div><p>在Lua引擎中:</p> <div class="language- extra-class"><pre class="language-text"><code>function initYg()
  bytes = {0x3B , 0x47 , 0x28 , 0x7E , 0x12}

  -- 要创建符号autoAssemble里面才能访问
  address = '&quot;PlantsVsZombies.exe&quot;+B2FF0'
  registerSymbol(&quot;address&quot;, address)

  mem = allocateMemory(0x1000)
  registerSymbol(&quot;newmem&quot;, mem)

  autoAssemble([[
    label(return)

    newmem:
      cmp eax,[edi+28]
      nop
      nop
      jmp return

    address:
      jmp newmem
    return:
  ]])
end

function disposeYg()
  writeBytes(address, bytes)

  unregisterSymbol(&quot;newmem&quot;)
  unregisterSymbol(&quot;address&quot;)
  deAlloc(mem, 0x1000)

  address = nil
  mem = nil
  bytes = nil
end
</code></pre></div><h2 id="使用settimeout和setinterval更简单的计时器"><a href="#使用settimeout和setinterval更简单的计时器" class="header-anchor">#</a> <a href="https://github.com/januwA/CEScript-timer" target="_blank" rel="noopener noreferrer">使用<code>setTimeout</code>和<code>setInterval</code>更简单的计时器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <h2 id="自动附加到进程"><a href="#自动附加到进程" class="header-anchor">#</a> 自动附加到进程</h2> <p>每隔1s去找'game2.exe'是否运行，找到后附加进程并且结束计时器</p> <div class="language- extra-class"><pre class="language-text"><code>local PROCESS_NAME = 'game2.exe'

id = setInterval(function()
  print('find...')
  if getProcessIDFromProcessName(PROCESS_NAME) ~= nil then
     print('finded.')
    clearInterval(id)
    openProcess(PROCESS_NAME)
  end
end, 1000)
</code></pre></div><h2 id="使用ini配置"><a href="#使用ini配置" class="header-anchor">#</a> <a href="https://santoslove.github.io/inifile.html" target="_blank" rel="noopener noreferrer">使用ini配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>将<code>inifile.lua</code>文件放在autorun文件夹中，并且将inifile改为全局对象</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}
if syntaxcheck then return end

[ENABLE]

--[[iniTable = {}

iniTable['1'] = {x = 10, y = 100, z = 22}
iniTable['2'] = {x = 20, y = 200, z = 33}
iniTable['3'] = {x = 30, y = 300, z = 44}

inifile.save('example.ini', iniTable)
--]]

 iniTable = inifile.parse('example.ini')
 showMessage(iniTable['1']['x'])
 
[DISABLE]
</code></pre></div><p>或者将<code>inifile.lua</code>放在脚本同目录，然后导入使用</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}
if syntaxcheck then return end

local INI = require &quot;inifile&quot;

[ENABLE]
 iniTable = INI.parse('example.ini')
 showMessage(iniTable['1']['x'])
 
[DISABLE]
</code></pre></div><h2 id="导入lua文件"><a href="#导入lua文件" class="header-anchor">#</a> 导入lua文件</h2> <div class="language- extra-class"><pre class="language-text"><code>-- 只会在第一次导入
require(&quot;mmm&quot;)

-- 每次使用都会导入
dofile(&quot;mmm.lua&quot;)
</code></pre></div><p>如果你要调试就用<code>dofile</code>否则就用<code>require</code>，lua脚本需要和CT文件放在同一级目录</p> <ul><li>https://wiki.cheatengine.org/index.php?title=Tutorials:Lua:Basics#Script_windows</li></ul> <h2 id="转换工具函数"><a href="#转换工具函数" class="header-anchor">#</a> 转换工具函数</h2> <div class="language- extra-class"><pre class="language-text"><code>local bt = floatToByteTable(1000.0)

 for k, v in pairs(bt) do
   print(string.format('%02X', v))
 end

 print( byteTableToFloat({0x00, 0x00, 0x7a, 0x44}) )

print('-----')
bt =  dwordToByteTable(10)
 for k, v in pairs(bt) do
   print(string.format('%02X', v))
 end
 print(	byteTableToDword({0x0a,0x00,0x00,0x00}) )
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>00 
00 
7A 
44 
1000.0 
----- 
0A 
00 
00 
00 
10 
</code></pre></div><h2 id="在远程进程中执行messageboxa-x64"><a href="#在远程进程中执行messageboxa-x64" class="header-anchor">#</a> <a href="https://forum.cheatengine.org/viewtopic.php?t=604716&amp;sid=69f971193a403f527ea8d96f48007867" target="_blank" rel="noopener noreferrer">在远程进程中执行MessageBoxA x64<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <div class="language- extra-class"><pre class="language-text"><code>if messageBoxACaller==nil then
  if autoAssemble([[
    alloc(messageBoxACaller,128)
    registersymbol(messageBoxACaller)
messageBoxACaller:
    sub rsp,0x28
    mov r9,[rcx+18] //button
    mov r8,[rcx+10] //caption
    mov rdx,[rcx+8] //text
    mov rcx,[rcx] //hwnd
    call MessageBoxA

    add rsp,0x28
    ret

  ]]) then
    messageBoxACaller=getAddressSafe('messageBoxACaller')
  end
end

if messageBoxACaller==nil then
  error('autoAssemble failed')
end

function MessageBox(hwnd, message, caption, button)
  -- 申请一块内存,返回地址
  local mymem=allocateMemory(512)

  -- 从申请得到的地址开始写入数据
  local captionaddress
  writeString(mymem, message)
  writeBytes(mymem+#message,0) --0 terminator
  captionaddress=mymem+#message+1

  -- 偏移地址后，继续写入数据
  writeString(captionaddress,caption)
  writeBytes(captionaddress+#caption,0)

  -- 偏移地址后，继续写入数据
  local params=captionaddress+#caption+1
  writeQword(params,hwnd) --hwnd
  writeQword(params+8,mymem) --text
  writeQword(params+16,captionaddress) --caption
  writeQword(params+24,button) --button (0=ok)

  -- 执行函数传入params地址，并等待返回
  local r = executeCode(messageBoxACaller,params)

  deAlloc(mymem)
  return r
end

print( MessageBox(0, 'BLA','XXX',2) )
</code></pre></div><h2 id="设置游戏速度"><a href="#设置游戏速度" class="header-anchor">#</a> 设置游戏速度</h2> <p>1为正常,大于1加速，小于1减速</p> <div class="language- extra-class"><pre class="language-text"><code>speedhack_setSpeed(1.5)
speedhack_getSpeed()
</code></pre></div><h2 id="aobscan-找到过于复杂的字节集"><a href="#aobscan-找到过于复杂的字节集" class="header-anchor">#</a> AOBScan 找到过于复杂的字节集</h2> <div class="language- extra-class"><pre class="language-text"><code>local res = AOBScan(&quot;A3 24 37 4B 00&quot;)

if res == nil then return end

-- 可能返回多个相同字节集的地方
for i=0, res.Count-1, 1 do
  -- print( type(res[i]) ) string
  -- print(  res[i] + 3 ) 移动3字节

  -- 判断其中一个字节,找到自己想要的位置
  if  readBytes( '0x'..(res[i]+3) ) ~= 0 then

    -- 注册helloSymbol符号
    registerSymbol('helloSymbol', res[i])
  end
end
res.destroy()
</code></pre></div><h2 id="重写多个相同的字节集"><a href="#重写多个相同的字节集" class="header-anchor">#</a> 重写多个相同的字节集</h2> <p>将找到的所有字节集全部指向设置的函数</p> <p>创建函数newmemTest:</p> <div class="language- extra-class"><pre class="language-text"><code>[ENABLE]
// 申请100字节大小的内存来存放函数
alloc(newmemTest,$100)
registersymbol(newmemTest)

newmemTest:
  mov [ecx+70],(float)0
  ret

[DISABLE]
unregistersymbol(newmemTest)
dealloc(newmemTest)
</code></pre></div><p>扫描所有字节集，全部重写：</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}

if syntaxcheck then return end

[ENABLE]
-- 获取秒杀函数地址
local funAddres = getAddressSafe('newmemTest')
if funAddres == nil then return end


-- 获取所有
aobs = AOBScan(&quot;F3 0F 11 49 70&quot;)
if aobs == nil then return end


for i=0, aobs.Count-1, 1 do
  -- 获取新的字节集
  -- https://github.com/januwA/ce-plugins/blob/master/getJmpNewBytes.lua
  local newJmpBytes = getJmpNewBytes('0x'..aobs[i], funAddres, 5, { 0xE8 })
  -- 写入新的字节集
  writeBytes('0x'..aobs[i], newJmpBytes)
end
 
 
[DISABLE]
-- 恢复所有字节集
for i=0, aobs.Count-1, 1 do
  writeBytes('0x'..aobs[i], {0xF3, 0x0F, 0x11, 0x49, 0x70})
end
aobs.destroy()
aobs = nil
</code></pre></div><h2 id="获取当前脚本memoryrecord上下文"><a href="#获取当前脚本memoryrecord上下文" class="header-anchor">#</a> 获取当前脚本MemoryRecord上下文</h2> <div class="language- extra-class"><pre class="language-text"><code> -- getAddressList().getMemoryRecordByDescription('des').Active = false
 memrec.Active = false
</code></pre></div><h2 id="aa脚本调用lua函数"><a href="#aa脚本调用lua函数" class="header-anchor">#</a> AA脚本调用LUA函数</h2> <ul><li>https://forum.cheatengine.org/viewtopic.php?t=605733</li></ul> <p>x86</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}
function myfunction(p1, p2, p3)
  print(p1, p2, p3)
  -- mov eax,#100
  return 100
end
{$asm}

// =================================== 加载dll
loadlibrary(luaclient-i386.dll)
luacall(openLuaServer('CELUASERVER'))
CELUA_ServerName:
  db 'CELUASERVER',0
// ===================================


define(address,&quot;game2.exe&quot;+1575)
define(bytes,A3 24 37 4B 00)

[ENABLE]

assert(address,bytes)
alloc(newmem,$1000)

label(code)
label(return)

// ==================== 函数id和函数名
alloc(functionid,4)
alloc(functionname,16)
functionid:
dd 0
functionname:
db 'myfunction',0
// ====================


newmem:
  push eax
  push edx
  push ecx

  mov ecx,[functionid]
  test ecx,ecx
  jne call_my_fun // 有functionid 跳

  // functionid = CELUA_GetFunctionReferenceFromName(functionname)
  push eax
  push functionname
  call CELUA_GetFunctionReferenceFromName
  mov [functionid],eax
  mov ecx,eax
  pop eax

call_my_fun:
  push ebp
  mov ebp,esp

  // 参数顺序 从左向右
  sub esp,0C //allocate space ofr 1 parameter
  mov [ebp-04],3   // p3
  mov [ebp-08],2   // p2
  mov [ebp-0c],eax // p1

  // CELUA_ExecuteFunctionByReference(函数id, 函数需要多少参数, 函数参数地址, 同步还是异步)
  push 0 //0 同步跟新gui, 1 异步不会跟新gui
  lea edx,[ebp-0C]
  push edx //address of the parameter list
  push 3 //number of parameters (1)
  push ecx //functionid reference

  call CELUA_ExecuteFunctionByReference

  mov esp,ebp
  pop ebp

  pop ecx
  pop edx
  pop eax

code:
  mov [game2.exe+B3724],eax
  jmp return

address:
  jmp newmem
return:

[DISABLE]
address:
  db bytes

dealloc(newmem)
</code></pre></div><p>x64</p> <div class="language- extra-class"><pre class="language-text"><code>{$lua}
function myfunction(p1, p2, p3)
  print(p1, p2, p3)
  -- mov eax,0
  return 0
end
{$asm}

//======================================
loadlibrary(luaclient-x86_64.dll)
luacall(openLuaServer('CELUASERVER'))
CELUA_ServerName:
  db 'CELUASERVER',0

alloc(functionid,4)
alloc(functionname,16)
functionid:
  dd 0
functionname:
  db 'myfunction',0
//======================================


define(address,&quot;Tutorial-x86_64.exe&quot;+2B08C)
define(bytes,29 83 F0 07 00 00)

[ENABLE]
assert(address,bytes)
alloc(newmem,$1000,&quot;Tutorial-x86_64.exe&quot;+2B08C)

label(code)
label(return)

newmem:
  // 保存旧寄存器、函数调用和paramlist分配空间（并保持16字节对齐）
  // 旧寄存器 7*8=56
  // 函数调用 4*8=32
  // paramlist 3*8=24
  // 56+32+24=112=0x70
  sub rsp,70
  mov [rsp+20],rcx // 这里偏移20，将前面的位置留给函数内部
  mov [rsp+28],rdx
  mov [rsp+30],r8
  mov [rsp+38],r9
  mov [rsp+40],r10
  mov [rsp+48],r11
  mov [rsp+50],rax
  //[rsp+58]=paramlist

  mov ecx,[functionid]
  test ecx,ecx
  jne hasrefid

  // functionid = CELUA_GetFunctionReferenceFromName(functionname)
  mov rcx,functionname
  call CELUA_GetFunctionReferenceFromName
  mov [functionid],eax
  mov ecx,eax

hasrefid:

  // CELUA_ExecuteFunctionByReference(rcx 函数id, rdx 函数需要多少参数, r8 函数参数地址, r9 同步还是异步)
  mov rdx,3

  lea r8,[rsp+58] // paramlist

  mov rax,[rsp+50]
  mov [r8],rax            // p1

  mov rax,2
  mov [r8+8],rax  // p2

  mov rax,3
  mov [r8+10],rax  // p3

  mov r9,0
  call CELUA_ExecuteFunctionByReference

  mov rcx,[rsp+20]
  mov rdx,[rsp+28]
  mov r8,[rsp+30]
  mov r9,[rsp+38]
  mov r10,[rsp+40]
  mov r11,[rsp+48]
  //mov rax,[rsp+50]
  add rsp,70
code:
  sub [rbx+000007F0],eax
  jmp return

address:
  jmp newmem
  nop
return:

[DISABLE]
address:
  db bytes

dealloc(newmem)
</code></pre></div><h2 id="xbox-按键"><a href="#xbox-按键" class="header-anchor">#</a> XBOX 按键</h2> <ul><li>https://wiki.cheatengine.org/index.php?title=Lua:getXBox360ControllerState</li></ul> <div class="language- extra-class"><pre class="language-text"><code>xboxState = getXBox360ControllerState()
require 'pl.pretty'.dump(xboxState)
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>{
  ControllerID = 0,
  PacketNumber = 4587,

  GAMEPAD_A = false,
  GAMEPAD_B = false,
  GAMEPAD_X = false,
  GAMEPAD_Y = false,

  GAMEPAD_BACK = false,
  GAMEPAD_START = false,
  
  // 十字键
  GAMEPAD_DPAD_DOWN = false,
  GAMEPAD_DPAD_LEFT = false,
  GAMEPAD_DPAD_RIGHT = false,
  GAMEPAD_DPAD_UP = false,
  
  // LB和RB
  GAMEPAD_LEFT_SHOULDER = false,
  GAMEPAD_RIGHT_SHOULDER = false,
  
  // LT和RT
  LeftTrigger = 0,
  RightTrigger = 97,
  
  //左摇杆按下和右摇杆按下
  GAMEPAD_LEFT_THUMB = false,
  GAMEPAD_RIGHT_THUMB = false,
  
  // 左摇杆 -32768至32767
  ThumbLeftX = 328,
  ThumbLeftY = -1536,
  
  // 右摇杆 -32768至32767
  ThumbRightX = 649,
  ThumbRightY = -3097,

  // 不知道是什么
  wButtons = 0
} 
</code></pre></div><h2 id="获取打开的进程id"><a href="#获取打开的进程id" class="header-anchor">#</a> 获取打开的进程ID</h2> <div class="language- extra-class"><pre class="language-text"><code>pid = getOpenedProcessID()
</code></pre></div><h2 id="获取目标进程的窗口句柄"><a href="#获取目标进程的窗口句柄" class="header-anchor">#</a> 获取目标进程的窗口句柄</h2> <div class="language- extra-class"><pre class="language-text"><code>w=getWindow(getForegroundWindow(), GW_HWNDFIRST)

pid=getOpenedProcessID()

while w and (w~=0) do
  if getWindowProcessID(w)==pid then
    print(w..' - '..getWindowCaption(w)..'('..getWindowClassName(w)..')')
  end
  w=getWindow(w,GW_HWNDNEXT)
end
</code></pre></div><h2 id="获取窗口的rect"><a href="#获取窗口的rect" class="header-anchor">#</a> 获取窗口的RECT</h2> <ul><li>https://www.cheatengine.org/forum/viewtopic.php?t=613162&amp;postdays=0&amp;postorder=asc&amp;start=0&amp;sid=5ae16ed6a3b6d91917d56252b0d82046</li> <li>https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowrect</li> <li>https://docs.microsoft.com/en-us/windows/win32/api/windef/ns-windef-rect</li> <li>https://wiki.cheatengine.org/index.php?title=Lua:createMemoryStream</li> <li>使用getTargetWindowRect https://github.com/januwA/ce-plugins</li></ul> <div class="language- extra-class"><pre class="language-text"><code>dump( getTargetWindowRect() )
</code></pre></div><h2 id="在lua中调用win32-api"><a href="#在lua中调用win32-api" class="header-anchor">#</a> 在LUA中调用win32 API</h2> <div class="language- extra-class"><pre class="language-text"><code>if executeCodeLocalEx(&quot;MessageBoxA&quot;, 0, &quot;a&quot;, &quot;title&quot;, 0) then
  print(&quot;ok&quot;)
end
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/game-reversed-study/LUA/lua-plugin.html" class="prev">
        lua-plugin
      </a></span> <span class="next"><a href="/game-reversed-study/LUA/使用计时器.html">
        使用计时器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/game-reversed-study/assets/js/app.ed2c23ab.js" defer></script><script src="/game-reversed-study/assets/js/2.2445e019.js" defer></script><script src="/game-reversed-study/assets/js/13.86901e94.js" defer></script>
  </body>
</html>
